name: HidenCloudå¤šè´¦å·è‡ªåŠ¨ç»­æœŸ

on:
  # å®šæ—¶è¿è¡Œ - æ¯å¤©ä¸Šåˆ9ç‚¹ï¼ˆUTCæ—¶é—´1ç‚¹ï¼‰
  schedule:
    - cron: '0 1 * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  auto-renewal:
    runs-on: ubuntu-latest
    
    # æˆäºˆå·¥ä½œæµå†™å…¥ä»“åº“å†…å®¹å’Œç®¡ç†Actionsçš„æƒé™
    permissions:
      contents: write
      actions: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install playwright>=1.40.0 python-dotenv>=1.0.0
        # å®‰è£… Playwright æµè§ˆå™¨
        playwright install chromium
        # å®‰è£…ç³»ç»Ÿä¾èµ–
        playwright install-deps chromium
    
    - name: Run multi-account auto renewal script
      env:
        HIDENCLOUD_ACCOUNTS: ${{ secrets.HIDENCLOUD_ACCOUNTS }}
      run: |
        python main.py
    
    - name: Upload screenshots
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: screenshots-${{ github.run_id }}
        path: "*.png"
        retention-days: 3
    
    - name: Commit and push README.md
      if: always()
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add README.md
        git diff --staged --quiet || git commit -m "Update README.md with latest run results [$(date +'%Y-%m-%d %H:%M:%S')]"
        git push
    
    - name: Send Telegram notification
      if: always() && env.TELEGRAM_BOT_TOKEN != '' && env.TELEGRAM_CHAT_ID != ''
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        # æå–README.mdä¸­çš„å…³é”®ä¿¡æ¯
        if [ -f "README.md" ]; then
          # ç»Ÿè®¡æˆåŠŸå’Œå¤±è´¥çš„æœåŠ¡å™¨æ•°é‡
          SUCCESS_COUNT=$(grep -c "âœ…Success" README.md || echo "0")
          UNEXPIRED_COUNT=$(grep -c "â„¹ï¸Unexpired" README.md || echo "0")
          FAILED_COUNT=$(grep -c "âŒ" README.md || echo "0")
          TOTAL_COUNT=$((SUCCESS_COUNT + UNEXPIRED_COUNT + FAILED_COUNT))
          
          # æå–è´¦å·æ•°é‡
          ACCOUNT_COUNT=$(grep -c "### è´¦å·:" README.md || echo "0")
        else
          SUCCESS_COUNT="0"
          UNEXPIRED_COUNT="0"
          FAILED_COUNT="0"
          TOTAL_COUNT="0"
          ACCOUNT_COUNT="0"
        fi
        
        # æ„å»ºé€šçŸ¥æ¶ˆæ¯
        MESSAGE="â˜ï¸ HidenCloudå¤šè´¦å·ç»­æœŸé€šçŸ¥
        ğŸ“… æ‰§è¡Œæ—¶é—´ï¼š$(date +'%Y-%m-%d %H:%M:%S')
        
        ğŸ‘¥ å¤„ç†è´¦å·æ•°ï¼š${ACCOUNT_COUNT}
        ğŸ–¥ï¸ æœåŠ¡å™¨æ€»æ•°ï¼š${TOTAL_COUNT}
        
        ğŸ“Š æ‰§è¡Œç»“æœï¼š
        âœ… ç»­æœŸæˆåŠŸï¼š${SUCCESS_COUNT}
        â„¹ï¸ æœªåˆ°æœŸé™ï¼š${UNEXPIRED_COUNT}
        âŒ å¤„ç†å¤±è´¥ï¼š${FAILED_COUNT}
        
        ğŸ“‹ è¯¦ç»†ä¿¡æ¯ï¼š
        ğŸ”— [æŸ¥çœ‹è¿è¡Œæ—¥å¿—](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
        ğŸ“¸ [ä¸‹è½½æˆªå›¾](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)
        ğŸ“„ [æŸ¥çœ‹å®Œæ•´æŠ¥å‘Š](https://github.com/${{ github.repository }}/blob/main/README.md)"
        
        # å‘é€Telegramæ¶ˆæ¯
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
          -d chat_id="${TELEGRAM_CHAT_ID}" \
          -d text="${MESSAGE}" \
          -d parse_mode="Markdown"
    
    - name: Telegramé€šçŸ¥è·³è¿‡æç¤º
      if: always() && (env.TELEGRAM_BOT_TOKEN == '' || env.TELEGRAM_CHAT_ID == '')
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: echo "æœªé…ç½®Telegramå˜é‡ï¼Œè·³è¿‡é€šçŸ¥"

    - name: Delete old workflow runs
      uses: MajorScruffy/delete-old-workflow-runs@v0.3.0
      env:
        GITHUB_TOKEN: ${{ github.token }}
      with:
        repository: ${{ github.repository }}
        older-than-seconds: 172800  # åˆ é™¤2å¤©å‰çš„è®°å½•
